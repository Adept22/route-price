var myMap,
	polygon = { 
		"type": "Polygon",
 		"coordinates":	
		[
			[
				[55.824944, 38.424469],
				[55.823494, 38.424383],
				[55.822479, 38.424383],
				[55.762262, 38.435993],
				[55.754034, 38.442516],
				[55.753260, 38.443289],
				[55.748274, 38.452473],
				[55.738590, 38.457365],
				[55.734204, 38.432474],
				[55.733381, 38.430586],
				[55.732800, 38.429813],
				[55.727472, 38.425350],
				[55.725244, 38.421917],
				[55.724517, 38.420372],
				[55.723355, 38.419342],
				[55.722822, 38.417883],
				[55.722289, 38.417797],
				[55.701828, 38.434351],
				[55.700277, 38.434866],
				[55.699114, 38.434780],
				[55.697659, 38.434351],
				[55.696351, 38.433578],
				[55.695333, 38.432462],
				[55.669290, 38.392738],
				[55.668756, 38.391965],
				[55.632572, 38.360854],
				[55.631067, 38.359137],
				[55.630533, 38.360597],
				[55.628251, 38.363601],
				[55.627279, 38.365403],
				[55.625483, 38.365489],
				[55.617177, 38.371154],
				[55.540756, 38.405143],
				[55.538809, 38.405487],
				[55.537008, 38.405058],
				[55.535451, 38.404028],
				[55.530600, 38.399596],
				[55.495801, 38.374208],
				[55.492488, 38.369659],
				[55.485567, 38.350347],
				[55.483715, 38.348030],
				[55.483082, 38.347686],
				[55.477128, 38.345798],
				[55.444153, 38.319847],
				[55.440836, 38.318874],
				[55.438445, 38.318445],
				[55.433809, 38.315870],
				[55.432638, 38.314755],
				[55.431320, 38.311836],
				[55.427432, 38.298017],
				[55.426504, 38.296301],
				[55.425479, 38.295099],
				[55.424601, 38.294412],
				[55.420402, 38.292524],
				[55.419374, 38.291133],
				[55.414980, 38.280490],
				[55.414687, 38.277658],
				[55.414296, 38.266843],
				[55.415761, 38.246158],
				[55.415566, 38.245128],
				[55.409169, 38.232425],
				[55.408241, 38.231309],
				[55.407118, 38.230279],
				[55.399304, 38.226159],
				[55.396568, 38.222040],
				[55.393305, 38.208221],
				[55.390472, 38.201612],
				[55.386954, 38.193458],
				[55.383240, 38.188480],
				[55.379543, 38.180616],
				[55.376806, 38.172376],
				[55.376220, 38.170059],
				[55.362277, 38.001672],
				[55.362456, 37.997847],
				[55.362847, 37.995358],
				[55.363384, 37.993212],
				[55.368224, 37.977934],
				[55.368615, 37.974759],
				[55.368615, 37.971411],
				[55.368273, 37.967549],
				[55.367882, 37.965746],
				[55.343528, 37.863397],
				[55.343088, 37.860393],
				[55.343088, 37.858075],
				[55.343609, 37.851158],
				[55.343560, 37.848326],
				[55.343316, 37.844721],
				[55.334289, 37.766858],
				[55.333699, 37.747240],
				[55.332019, 37.721294],
				[55.331036, 37.602687],
				[55.331613, 37.595398],
				[55.331417, 37.583210],
				[55.333921, 37.481331],
				[55.334215, 37.477469],
				[55.334606, 37.474808],
				[55.335242, 37.472233],
				[55.336465, 37.469658],
				[55.353502, 37.442467],
				[55.370077, 37.420636],
				[55.371348, 37.418233],
				[55.372375, 37.415057],
				[55.375552, 37.399436],
				[55.389766, 37.348064],
				[55.390059, 37.346433],
				[55.394372, 37.255174],
				[55.394617, 37.252428],
				[55.395301, 37.249595],
				[55.406250, 37.205326],
				[55.407178, 37.203094],
				[55.408301, 37.201378],
				[55.418164, 37.189619],
				[55.419326, 37.187656],
				[55.442697, 37.141860],
				[55.480012, 37.055497],
				[55.480792, 37.054038],
				[55.525261, 36.980097],
				[55.526478, 36.979067],
				[55.527257, 36.978723],
				[55.528036, 36.978552],
				[55.528815, 36.978723],
				[55.529546, 36.979152],
				[55.530276, 36.979582],
				[55.531249, 36.980612],
				[55.533976, 36.983701],
				[55.534462, 36.984302],
				[55.538162, 36.989710],
				[55.538843, 36.990225],
				[55.539865, 36.990225],
				[55.548708, 36.983945],
				[55.549438, 36.984116],
				[55.565079, 36.995961],
				[55.565857, 36.996390],
				[55.582780, 37.001368],
				[55.583120, 37.001197],
				[55.584287, 37.001368],
				[55.585113, 37.001111],
				[55.588273, 37.001712],
				[55.588419, 37.002141],
				[55.588808, 37.003171],
				[55.592939, 37.004544],
				[55.593474, 37.005059],
				[55.594932, 37.008492],
				[55.595661, 37.008922],
				[55.596293, 37.008578],
				[55.603437, 37.005145],
				[55.608545, 37.001571],
				[55.623588, 37.020070],
				[55.624414, 37.020155],
				[55.629707, 37.021271],
				[55.629901, 36.983849],
				[55.638107, 36.983849],
				[55.647476, 36.973807],
				[55.651543, 36.970707],
				[55.653727, 36.969677],
				[55.659453, 36.967360],
				[55.664548, 36.963755],
				[55.666391, 36.963068],
				[55.666634, 36.962725],
				[55.667847, 36.957489],
				[55.671776, 36.947704],
				[55.673668, 36.938177],
				[55.676481, 36.928993],
				[55.678663, 36.917492],
				[55.683367, 36.903158],
				[55.695432, 36.889119],
				[55.698195, 36.885085],
				[55.707259, 36.875386],
				[55.708616, 36.874356],
				[55.712831, 36.872296],
				[55.713219, 36.869893],
				[55.713655, 36.868262],
				[55.714818, 36.866460],
				[55.716950, 36.866202],
				[55.726542, 36.861739],
				[55.728479, 36.866631],
				[55.730320, 36.869120],
				[55.731337, 36.869550],
				[55.734194, 36.873069],
				[55.735889, 36.874528],
				[55.747718, 36.886141],
				[55.770066, 36.905366],
				[55.788528, 36.920864],
				[55.790127, 36.921722],
				[55.791626, 36.921894],
				[55.793125, 36.921808],
				[55.819953, 36.917603],
				[55.821741, 36.917860],
				[55.828892, 36.919834],
				[55.847498, 36.925139],
				[55.848778, 36.925868],
				[55.850057, 36.926813],
				[55.851240, 36.927971],
				[55.856937, 36.933936],
				[55.857154, 36.934409],
				[55.859882, 36.937155],
				[55.860268, 36.937413],
				[55.862609, 36.939515],
				[55.863768, 36.939988],
				[55.876798, 36.943335],
				[55.877015, 36.943592],
				[55.891347, 36.944547],
				[55.891540, 36.944376],
				[55.922056, 36.946158],
				[55.923285, 36.946458],
				[55.924490, 36.947102],
				[55.925960, 36.947960],
				[55.927261, 36.949119],
				[55.928470, 36.950291],
				[55.976057, 36.999984],
				[55.976635, 37.000713],
				[55.977934, 37.002473],
				[55.991282, 37.020652],
				[55.992533, 37.021639],
				[55.993953, 37.022283],
				[56.002385, 37.025276],
				[56.004814, 37.023989],
				[56.005199, 37.023989],
				[56.005535, 37.024031],
				[56.005920, 37.024203],
				[56.006233, 37.024332],
				[56.006713, 37.024761],
				[56.007074, 37.025319],
				[56.010163, 37.027571],
				[56.016088, 37.029676],
				[56.017602, 37.030920],
				[56.019045, 37.032894],
				[56.020198, 37.035255],
				[56.021568, 37.039031],
				[56.054063, 37.132605],
				[56.055287, 37.135567],
				[56.056872, 37.137841],
				[56.060978, 37.143420],
				[56.072958, 37.130717],
				[56.103031, 37.182845],
				[56.104182, 37.184304],
				[56.107012, 37.187565],
				[56.108176, 37.189708],
				[56.109159, 37.193098],
				[56.109998, 37.196574],
				[56.112588, 37.209921],
				[56.115057, 37.218461],
				[56.115657, 37.221980],
				[56.120043, 37.268895],
				[56.120091, 37.272886],
				[56.125342, 37.338432],
				[56.125677, 37.340577],
				[56.125989, 37.342122],
				[56.134042, 37.374051],
				[56.134425, 37.376326],
				[56.134641, 37.378858],
				[56.134737, 37.381476],
				[56.136646, 37.450245],
				[56.137868, 37.467626],
				[56.137964, 37.469514],
				[56.138362, 37.490400],
				[56.138749, 37.495214],
				[56.142765, 37.492682],
				[56.152348, 37.487294],
				[56.153090, 37.487122],
				[56.157400, 37.487489],
				[56.158143, 37.488047],
				[56.159101, 37.489356],
				[56.159687, 37.490837],
				[56.160849, 37.494141],
				[56.161447, 37.497596],
				[56.162405, 37.499548],
				[56.168935, 37.505630],
				[56.170658, 37.506446],
				[56.171293, 37.506853],
				[56.175243, 37.510308],
				[56.178786, 37.514449],
				[56.185070, 37.518010],
				[56.190834, 37.522508],
				[56.192138, 37.523195],
				[56.193956, 37.523624],
				[56.199699, 37.524483],
				[56.202978, 37.524052],
				[56.206184, 37.523237],
				[56.205825, 37.538128],
				[56.205323, 37.543493],
				[56.204892, 37.545124],
				[56.196773, 37.563942],
				[56.196223, 37.565573],
				[56.195673, 37.567419],
				[56.192832, 37.579693],
				[56.191898, 37.582783],
				[56.186225, 37.600836],
				[56.186037, 37.602129],
				[56.185870, 37.604704],
				[56.183524, 37.617922],
				[56.157904, 37.723256],
				[56.157665, 37.724844],
				[56.142095, 37.845068],
				[56.141544, 37.847728],
				[56.138149, 37.862593],
				[56.137167, 37.865554],
				[56.133093, 37.874695],
				[56.132446, 37.876498],
				[56.131655, 37.879587],
				[56.130265, 37.886583],
				[56.120472, 37.934447],
				[56.119969, 37.936121],
				[56.119441, 37.937322],
				[56.118770, 37.938610],
				[56.089632, 37.990330],
				[56.085218, 37.998999],
				[56.083946, 38.001960],
				[56.082794, 38.005393],
				[56.078690, 38.025735],
				[56.078354, 38.027495],
				[56.075672, 38.047539],
				[56.075264, 38.050629],
				[56.071953, 38.075763],
				[56.071521, 38.078467],
				[56.070998, 38.081107],
				[56.070374, 38.083296],
				[56.067383, 38.092427],
				[56.066495, 38.094744],
				[56.043923, 38.164200],
				[56.043178, 38.167118],
				[56.042770, 38.169392],
				[56.042385, 38.172439],
				[56.040274, 38.191487],
				[56.039722, 38.194277],
				[56.038593, 38.198053],
				[56.037127, 38.201967],
				[56.028484, 38.217822],
				[56.027571, 38.219925],
				[56.002236, 38.295102],
				[56.001346, 38.298407],
				[56.000982, 38.300679],
				[56.000934, 38.303426],
				[56.001151, 38.306816],
				[56.001083, 38.309182],
				[56.000626, 38.311671],
				[55.999616, 38.314547],
				[55.989153, 38.330683],
				[55.982922, 38.342999],
				[55.958714, 38.366835],
				[55.958280, 38.367737],
				[55.952412, 38.385785],
				[55.951160, 38.387587],
				[55.949354, 38.390978],
				[55.948608, 38.392008],
				[55.947139, 38.393681],
				[55.943984, 38.398102],
				[55.941937, 38.399132],
				[55.941190, 38.399561],
				[55.937481, 38.400419],
				[55.936831, 38.400719],
				[55.935626, 38.401449],
				[55.934855, 38.401664],
				[55.931434, 38.402007],
				[55.930543, 38.402651],
				[55.929796, 38.403294],
				[55.929555, 38.403251],
				[55.928158, 38.402178],
				[55.927845, 38.402264],
				[55.926592, 38.403809],
				[55.925315, 38.404539],
				[55.923291, 38.404882],
				[55.922496, 38.404668],
				[55.917459, 38.403251],
				[55.915218, 38.404238],
				[55.913675, 38.405311],
				[55.911795, 38.405826],
				[55.909409, 38.405526],
				[55.907577, 38.405998],
				[55.906323, 38.406427],
				[55.904973, 38.407285],
				[55.903961, 38.407800],
				[55.903334, 38.408659],
				[55.901959, 38.412607],
				[55.901718, 38.416126],
				[55.901284, 38.417928],
				[55.899211, 38.420975],
				[55.898584, 38.421576],
				[55.896920, 38.422907],
				[55.894943, 38.425095],
				[55.894412, 38.425439],
				[55.893448, 38.425439],
				[55.891567, 38.426039],
				[55.888793, 38.424666],
				[55.887973, 38.424666],
				[55.886816, 38.424323],
				[55.886213, 38.424494],
				[55.875816, 38.431876],
				[55.872100, 38.435481],
				[55.869518, 38.437584],
				[55.867153, 38.440244],
				[55.866550, 38.440416],
				[55.865747, 38.440532],
				[55.863986, 38.440918],
				[55.859858, 38.439759],
				[55.859207, 38.440081],
				[55.852327, 38.445982],
				[55.847716, 38.430811],
				[55.843974, 38.429052],
				[55.829339, 38.425962]
			]
		],
		options: {
			fillOpacity: 0,
			interactivityModel: 'default#transparent',
		}
	},
	routeObjects,
	moscowPolygon,
	wayPoint,
	rate = getRate();

	function getRate() {
		var now = new Date(),
			nowYear = now.getFullYear(),
			today = new Date(nowYear, now.getMonth(), now.getDate()).valueOf(),
			summerStart = new Date(nowYear, 3, 1).valueOf(),
			summerEnd = new Date(nowYear, 10, 0).valueOf(), // Последний день сентября
			nowRate = (today >= summerStart && today <= summerEnd), // Летний - true, зимний - false
			fixedPrice = (nowRate ? 2000 : 2600),
			kmPrice = (nowRate ? 22 : 30);
		console.log(nowRate);
		return {
			fixedPrice: fixedPrice,
			kmPrice: kmPrice
		};
	};

function init() {
	myMap = new ymaps.Map("map", {
		center: [55.765220, 37.710063],
		zoom: 9,
		controls: ['zoomControl', 'typeSelector',  'fullscreenControl']
	});
	var suggestView = new ymaps.SuggestView('adress');
	
	loadPoly();
	
    /*moscowPolygon = new ymaps.Polygon(polygon.coordinates, null, polygon.options);
    myMap.geoObjects.add(moscowPolygon);*/
	
	myMap.events.add('click', function (e) {
		geocode(e.get('coords'));
	});
}

function reload(uMap) {
	$("#priceFromA107 span, #distance span, #inEnd span, #notice").text("");
	ymaps.geoQuery(myMap.geoObjects).search('geometry.type = "LineString"').removeFrom(myMap.geoObjects);
}

function loadPoly()
{
	var points = [
		{
			type: 'wayPoint',
			point: [56.159927, 37.714550]
		},
		{
			type: 'viaPoint',
			point: [55.725414, 36.862206]
		},
		{
			type: 'viaPoint',
			point: [55.397653, 37.239951]
		},
		{
			type: 'viaPoint',
			point: [55.660311, 38.384746]
		},
		{
			type: 'wayPoint',
			point: [56.159927, 37.714550]
		}
	];
	ymaps.route(points).then(function (res) {
		var pathsObjects = ymaps.geoQuery(res.getPaths()),
		    coords = [];
		pathsObjects.each(function (path) {
		    var coordinates = path.geometry.getCoordinates();
		    for (var i = 1, l = coordinates.length; i < l; i++) {
		        coords.push(coordinates[i]);
		    }
		});
		coords = [coords];
    	
		moscowPolygon = new ymaps.Polygon(coords, null, polygon.options);
    	myMap.geoObjects.add(moscowPolygon);
	}, function (e) {
		moscowPolygon = new ymaps.Polygon(polygon.coordinates, null, polygon.options);
    	myMap.geoObjects.add(moscowPolygon);
		console.log(e);
	});
}

function createPoint(coords, props) {
	if(!wayPoint) {
		wayPoint = new ymaps.GeoObject({
			geometry:
			{
				type: "Point",
				coordinates: coords
			}
		},
		{
    		preset: 'islands#redDotIconWithCaption',
    		draggable: true
    	});
		wayPoint.events.add("dragend", function(e) {
			geocode(e.get("target").geometry.getCoordinates());
		});
		routeObjects = ymaps.geoQuery(wayPoint).addToMap(myMap);
	} else {
		wayPoint.geometry.setCoordinates(coords);
	}
	wayPoint.properties.set(props);
}

function geocode(request) {
	ymaps.geocode(request).then(function (res) {
        var obj = res.geoObjects.get(0),
			mapContainer = $('#map'),
    	    bounds = obj.properties.get('boundedBy'),
    	    mapState = ymaps.util.bounds.getCenterAndZoom(
				bounds,
				[mapContainer.width(), mapContainer.height()]
    	    ),
			searchResult = {
				pointCoords: (Array.isArray(request) ? request : mapState.center),
				fullAddress: [obj.getCountry(), obj.getAddressLine()].join(', '),
				shortAddress: [obj.getThoroughfare(), obj.getPremiseNumber(), obj.getPremise()].join(' '),
				inPoly: searchInPoly(obj)
			};
		
		createPoint(searchResult.pointCoords, {iconCaption: searchResult.shortAddress, balloonContent: searchResult.fullAddress});
		//myMap.setCenter(mapState.center, mapState.zoom);
		reload(myMap);
		
		searchResult.inPoly ? calculate() : myRoute(searchResult.pointCoords);
	}, function (e) {
		$('#notice').text("Не удалось найти объект.");
		console.log(e);
	});
}

function searchInPoly(obj) {
	return (ymaps.geoQuery(obj).searchInside(moscowPolygon).getLength() == 0 ? false : true);
}

function calculate(distance = 0) {
	var fromA107Price = parseInt((2 * (rate.kmPrice * distance)));
	
	if(distance > 0) {
		$("#distance span").text(distance);
		$("#priceFromA107 span:last-child").text(fromA107Price);
	}
	
	$("#inEnd span").text(rate.fixedPrice + fromA107Price);
}

function getDistance(route) {
	var distance = 0;
	route.search('geometry.type = "LineString"').each(function (s) {
		distance += s.geometry.getDistance();
	});
	return Math.round(parseInt(distance) / 1000);
}

function myRoute(wayPointCoords) {
    ymaps.route(["Россия, г. Москва, ул. Сторожевая, д. 4с3", wayPointCoords]).then(
        function (res) {
            var pathsObjects = ymaps.geoQuery(res.getPaths()),
                edges = [];
            pathsObjects.each(function (path) {
                var coordinates = path.geometry.getCoordinates();
                for (var i = 1, l = coordinates.length; i < l; i++) {
                    edges.push({
                        type: 'LineString',
                        coordinates: [coordinates[i], coordinates[i - 1]]
                    });
                }
            });
            routeObjects = ymaps.geoQuery(edges).setOptions({strokeWidth: 3, strokeColor: '#ff0005'}).addToMap(myMap);
			
			var objectsInOnA107 = routeObjects.searchInside(moscowPolygon).searchIntersect(moscowPolygon),
				objectsOutA107 = routeObjects.remove(objectsInOnA107).setOptions({strokeColor: '#ff0005'}),
				distance = getDistance(objectsOutA107);
			objectsInOnA107.removeFromMap(myMap);
			calculate(distance);
		}
	);
}